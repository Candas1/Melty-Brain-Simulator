<html>
  <head>
  <script src="https://cdn.jsdelivr.net/npm/p5@0.10.2/lib/p5.js"></script>
<script>

let robot;
let scl = 2;
let ctrlsize = 200;

function setup() {

  //createCanvas(1200, 600);
  var cnv = createCanvas(windowWidth-50, windowHeight-50);
  cnv.style('display', 'block');

  rpmSlider = createSlider(0, 1000, 1);
  rpmSlider.position(50, 50);
  
  lowSlider = createSlider(0, 100, 10);
  lowSlider.position(50, 70);
  highSlider = createSlider(0, 100, 10);
  highSlider.position(50, 90);
  
  decSlider = createSlider(1, 100, 10);
  decSlider.position(50, 110);
  accSlider = createSlider(1, 100, 10);
  accSlider.position(50, 130);

  reset();
}

function windowResized() {
  resizeCanvas(windowWidth-50, windowHeight-50);
}

function reset(){
  background(0);// clear the screen
  robot = new Melty();
  robot.update();
}

function mouseWheel(event) {
  scl += event.delta * 0.001;
  return false;
}

function draw() {

  background(0);

  fill("white");
  textSize(15);
  text('Rpm(' + rpmSlider.value() + ')' , rpmSlider.x  + rpmSlider.width , rpmSlider.y-rpmSlider.height/2);
  text('Low rpm %(' + lowSlider.value() + ')' , lowSlider.x  + lowSlider.width , lowSlider.y-lowSlider.height/2);
  text('High rpm %('+ highSlider.value() + ')', highSlider.x + highSlider.width, highSlider.y-highSlider.height/2);
  text('Acc. %('+ accSlider.value() + ')' , accSlider.x  + accSlider.width , accSlider.y-accSlider.height/2);
  text('Dec. %('+ decSlider.value() + ')' , decSlider.x  + decSlider.width , decSlider.y-decSlider.height/2);
  text('Distance : ' + robot.distance, 50, 150);


  fill("grey");
  circle(width - ctrlsize/2,ctrlsize/2,ctrlsize);

  push(); // start a transformation matrix
  translate(width / 2, height / 2); // move to middle of screen

  scale(scl,scl*-1);
  
  robot.update();
  robot.move();
  robot.display();

  pop(); // pop down final transformation	 

}

function mouseClicked(){
  if (dist(width - ctrlsize/2,ctrlsize/2,mouseX,mouseY) > ctrlsize) return;

  let distx = width - ctrlsize/2 - mouseX;
  let disty = ctrlsize/2 - mouseY;

  let angle = degrees(Math.atan2(disty,distx)) + 180;
  if (angle < 0) angle += 360;
  angle = 360 - angle;
  document.getElementById("meltyAngle").value = angle;
}

class Melty {
  constructor() {
  this.px       = 0; // X position
  this.py       = 0; // Y position
  this.heading  = 0; // Heading
  this.headingr = 0; // Heading radian
  this.mx 	= 0; // X movement
  this.my 	= 0; // Y movement
  this.mo 	= 0; // angular movement
  this.speedl   = 0; // Current speed left 
  this.speedr   = 0; // Current speed right
  this.cspeedl  = 0; // Commanded speed left 
  this.cspeedr  = 0; // Commanded speed right
  this.speedavg = 0; // Average speed
  this.distance = 0; // Distance
  this.diff 	= 0; // Angle difference
	 
  this.diameter   = parseFloat(document.getElementById("diameter").value);   // Distance between wheel
  this.radius     = parseFloat(document.getElementById("radius").value);   // Wheel Radius
	
  this.rpm        = 0; // Speed rpm
  this.devhigh    = 0; // % speed high
  this.devlow     = 0; // % speed low
  this.meltyAngle = 0; // Commanded Angle
  this.accrate    = 0; // Acceleration Rate %
  this.decrate    = 0; // Deceleration Rate %
  this.wspeed     = 0; // wheel speed centimeter
  this.speedhigh  = 0; // Speed high
  this.speedlow   = 0; // Speed low
  this.accval     = 0; // Speed increment
  this.deccal     = 0; // Speed decrement
	
  }
  
  update(){
    this.rpm        = rpmSlider.value();   // Speed rpm
    this.devhigh    = highSlider.value(); // % speed high
    this.devlow     = lowSlider.value(); // % speed low
    this.meltyAngle = parseFloat(document.getElementById("meltyAngle").value);  // Commanded Angle
    this.accrate    = accSlider.value();  // Acceleration Rate %
    this.decrate    = decSlider.value();  // Deceleration Rate %
	
    this.wspeed = this.rpm * 2 * PI * this.radius / 60 / 60; // wheel speed centimeter
	
    this.speedhigh = this.wspeed + (this.wspeed * this.devhigh / 100); // Speed high
    this.speedlow  = this.wspeed - (this.wspeed * this.devlow  / 100); // Speed low
    this.accval    = this.wspeed * this.accrate / 100; // Speed increment 
    this.decval    = this.wspeed * this.decrate / 100; // Speed decrement
  }

  move() {
    
	// Calculate position based on previous movements
	this.px += this.mx;
	this.py += this.my;
	this.headingr = (this.headingr + this.mo) % (2 * PI);
	this.heading  = degrees(this.headingr);

	this.diff = 180 - abs(abs(this.meltyAngle - this.heading) - 180);

	// Set commanded speed based on difference between commanded and robot angle
	if (this.diff > 90){
	  this.cspeedr = this.speedlow;
	  this.cspeedl = this.speedhigh * -1;
	}else{
	  this.cspeedr = this.speedhigh;
	  this.cspeedl = this.speedlow * -1;  
	}

	if (this.cspeedl < this.speedl){
	  // Calculate Left wheel speed taking Acceleration rate into account
	  this.speedl = this.speedl + Math.max(this.cspeedl - this.speedl,this.accval * -1);
	}else{
	  // Calculate Left wheel speed taking Deceleration rate into account
	  this.speedl = this.speedl - Math.max(this.speedl - this.cspeedl,this.decval * -1);
	}

	if (this.cspeedr < this.speedr){
	  // Calculate Right wheel speed taking Acceleration rate into account
	  this.speedr = this.speedr + Math.min(this.cspeedr - this.speedr,this.accval);
	}else{
	  // Calculate Right wheel speed taking Deceleration rate into account
	  this.speedr = this.speedr - Math.min(this.speedr - this.cspeedr,this.decval);
	}

	// Average Speed
	this.speedavg = ( abs(this.speedr) + abs(this.speedl) )/ 2;

	//Calculate movements
	this.mx = (this.radius/2) * (this.speedr + this.speedl) * Math.cos(this.headingr);
	this.my = (this.radius/2) * (this.speedr + this.speedl) * Math.sin(this.headingr);
	this.mo = (this.radius / this.diameter) * (this.speedr - this.speedl);	

	this.distance = Math.round(dist(0,0,this.px,this.py));
	
  }

  display() {
  
    let sizewh = this.radius * 2;
    let sizeww = this.radius;
    let sizeb  = this.diameter + ( this.radius * 2 );
	
    translate(this.px,this.py);
    rotate(this.headingr);
	
    fill("grey"); 
    circle(0,0,sizeb);
    
    // Draw wheels
    fill( (this.diff > 90) ? "green" : "red" );
    rect( 0 - sizewh/2     , this.diameter/2 - sizeww/2 , sizewh , sizeww );
    fill( (this.diff > 90) ? "red" : "green" );
    rect( 0 - sizewh/2     , 0 - this.diameter/2 - sizeww/2 , sizewh , sizeww );
    
    // LED
    
    if (this.heading >= 350 || this.heading <= 10){
      stroke("Red");
      fill("red");
    }else{
      noStroke();
      fill("black");
    }
    circle(0 + sizeb/3 ,0 , sizeb/10);
	
  }
}

</script>


</head>
  <body>
  <label for="name">Distance between wheels</label>
  <input type="number" id="diameter" size="5" value="22" step="1">
  <label for="name">Wheel Radius</label>
  <input type="number" id="radius" size="5" value="8.4" step=".1">
  <label for="name">Melty Angle</label>
  <input type="number" id="meltyAngle" size="5" value="0">
  <button type="button" onclick="reset()" >Reset</button>
  </body>
  <style>
    input[type="number"] {
      width:50px;
    }
  </style>
</html>
